---
layout: post
title: Hello Test
---

it's first test page

```sql
	PROCEDURE SetStudy
	(
		p_event												OUT NUMBER,
		p_user_session_key						IN	VARCHAR2,
		p_program_name								IN	VARCHAR2,
		p_study_instance_uid 					IN	VARCHAR2,
		p_study_date 									IN	VARCHAR2,
		p_study_time 									IN	VARCHAR2 := NULL,
		p_study_access_no 						IN	VARCHAR2 := NULL,
		p_patient_id 									IN	VARCHAR2,
		p_patient_name 								IN	VARCHAR2 := NULL,
		p_other_patient_id 						IN	VARCHAR2 := NULL,
		p_other_patient_name 					IN	VARCHAR2 := NULL,
		p_patient_sex 								IN	VARCHAR2 := NULL,
		p_patient_bod 								IN	VARCHAR2 := NULL,
		p_patient_age 								IN	VARCHAR2 := NULL,
		p_patient_weight 							IN	VARCHAR2 := NULL,
		p_patient_height 							IN	VARCHAR2 := NULL,
		p_study_id 										IN	VARCHAR2 := NULL,
		p_study_description 					IN	VARCHAR2 := NULL,
		p_study_comment							 	IN	VARCHAR2 := NULL,
		p_referring_physician 				IN	VARCHAR2 := NULL,
		p_reading_physician	 					IN	VARCHAR2 := NULL,
		p_exam_department 						IN	VARCHAR2 := NULL,
		p_institution 								IN	VARCHAR2 := NULL,
		p_study_org_instance_uid			IN	VARCHAR2,
		p_modality_code								IN	VARCHAR2,
		p_mpeg_yn											IN	VARCHAR2
	)
	IS
		v_study_key		NUMBER;
		v_u_stdy_key	NUMBER;
		v_sysdate			DATE := SYSDATE;
		v_stdy_date_time	DATE := TO_DATE(p_study_date||p_study_time, 'YYYYMMDDHH24MISS');
		--v_study_time VARCHAR2(6) := NVL(p_study_time, TO_CHAR('000000000'));
		v_del_yn			study.del_yn%TYPE;
	BEGIN
		p_event := c_init_event;

		IF PKG_Login.CheckAvailableSession(p_user_session_key) = 0 THEN
			RAISE e_no_login;
		END IF;

		BEGIN
			INSERT INTO study
			( stdy_key
			, stdy_dt
			, prot_cd
			, specl_key
			, pat_id
			, dcm_pat_id
			, pat_othr_id
			, studyuid
			, dcm_studyuid
			, svc_cd
			, accs_no
			, dcm_accs_no
			, pat_key
			, stdy_id
			, pat_othr_id_key
			, pat_nm
			, dcm_pat_nm
			, refr_pyscn_usr
			, read_pyscn_usr
			, stdy_desc
			, mdlst
			, bodpat_lst
			, stdy_mod_dt
			, accs_dt
			, vrfy_usr
			, vrfy_dt
			, vrfy_yn
			, anno_rgs_dt
			, stdy_cmt
			, exam_dept
			, pat_age
			, pat_dob
			, pat_sex
			, pat_hght
			, pat_wgt
			, rgs_dt
			, specl_assi_from_usr
			, specl_assi_to_usr
			, mtc_yn
			, se_cnt
			, sop_cnt
			, sec_cd
			, mach_lst
			, read_rgs_dctr
			, prior_key
			, acq_flg_yn
			, mpeg_yn
			)
			VALUES
			( sq_study.NEXTVAL
			, v_stdy_date_time
			, NULL -- prot_cd
			, NULL -- specl_key
			, DECODE(p_patient_id,'NULL',NULL,p_patient_id)
			, DECODE(p_patient_id,'NULL',NULL,p_patient_id) -- org
			, p_other_patient_id
			, p_study_instance_uid
			, p_study_org_instance_uid
			, NULL -- svc_cd
			, p_study_access_no
			, p_study_access_no -- org
			, NULL -- pat_key: when match update
			, p_study_id
			, NULL -- pat_othr_id_key: when match update
			, p_patient_name
			, p_patient_name
			, p_referring_physician
			, p_reading_physician
			, p_study_description
			, p_modality_code -- mdlst
			, NULL -- bodpat_lst
			, NULL -- stdy_mod_dt
			, NULL -- accs_dt
			, NULL -- vrfy_usr
			, NULL -- vrfy_dt
			, 'N' -- vrfy_yn
			, NULL -- anno_rgs_dt
			, p_study_comment
			, p_exam_department
			, p_patient_age
			, TODATEDOB(p_patient_bod)
			, p_patient_sex
			, p_patient_height
			, p_patient_weight
			, v_sysdate-- rgs_dt
			, NULL -- specl_assi_from_usr
			, NULL -- specl_assi_to_usr
			, 'N' -- mtc_yn
			, 0 -- se_cnt
			, 0 -- sop_cnt
			, NULL -- sec_cd
			, NULL -- mach_lst
			, NULL -- read_rgs_dctr
			, NULL -- prior_key
			, 'Y'
			, p_mpeg_yn
			) RETURNING stdy_key INTO v_study_key;

			pkg_report.SetInitializeReport(p_event, p_user_session_key, p_program_name, v_study_key);

			p_event := c_insert_study;
		EXCEPTION
			WHEN DUP_VAL_ON_INDEX THEN
			  IF p_modality_code IN ('KO','SR','PR') THEN
					UPDATE	study
					SET		 rgs_dt = v_sysdate
							, acq_flg_yn = 'Y'
							, del_yn = 'N'
					WHERE	((studyuid = p_study_instance_uid) OR (dcm_studyuid = p_study_instance_uid))
							AND		p_patient_id IN (dcm_pat_id, pat_id)
							AND		NVL(accs_no, '-1;') = NVL(p_study_access_no, '-1;')
				    	    AND	 	TO_CHAR(stdy_dt, 'YYYYMMDD') = TO_CHAR(p_study_date)
					        --AND	 	mdlst = p_modality_code
		        	RETURNING stdy_key INTO v_u_stdy_key;

		           IF SQL%ROWCOUNT = 0 THEN
		           		p_event :=  c_sr_new_stud;
		           ELSE
		           		p_event :=  c_sr_upd_study;
		           END IF;

			  ELSE
					UPDATE	study
					SET		--stdy_dt = v_stdy_date_time
								--, prot_cd = NULL
								--, specl_key = NULL
								--, pat_id = p_patient_id
								--, pat_othr_id = p_other_patient_id
								--, studyuid = p_study_instance_uid
								--, svc_cd = NULL
	--							 accs_no = p_study_access_no
								--, pat_key = NULL -- when match update
								 stdy_id = p_study_id
								--, pat_othr_id_key = NULL -- when match update
	--							, pat_nm = p_patient_name
								, pat_nm = DECODE(mtc_yn, 'N', p_patient_name, pat_nm)
								--, refr_pyscn_usr = p_referring_physician
								, read_pyscn_usr = p_reading_physician
								, stdy_desc = p_study_description
								--, mdlst = NULL
								--, bodpat_lst = NULL
								--, stdy_mod_dt = NULL
								--, accs_dt = NULL
								--, vrfy_usr = NULL
								--, vrfy_dt = NULL
								--, vrfy_yn = NULL
								--, anno_rgs_dt = NULL
								, stdy_cmt = p_study_comment
								, exam_dept = p_exam_department
								, pat_age = p_patient_age
								, pat_dob = TODATEDOB(p_patient_bod)
								, pat_sex = p_patient_sex
								, pat_hght = p_patient_height
								, pat_wgt = p_patient_weight
								, rgs_dt = v_sysdate
								--, specl_assi_from_usr = NULL
								--, specl_assi_to_usr = NULL
								--, mtc_yn = 'N'
								--, se_cnt = NULL
								--, sop_cnt = NULL
								--, sec_cd = NULL
								--, mach_lst = NULL
								--, read_rgs_dctr = NULL
								--, prior_key = NULL
								, acq_flg_yn = 'Y'
								, del_yn = 'N'
								, mpeg_yn = DECODE(mpeg_yn, 'N', p_mpeg_yn, mpeg_yn)
					WHERE		studyuid = p_study_instance_uid
					AND			p_patient_id IN (dcm_pat_id, pat_id)
					AND			NVL(accs_no, '-1;') = NVL(p_study_access_no, '-1;')
	        AND			TO_CHAR(stdy_dt, 'YYYYMMDD') = TO_CHAR(p_study_date)
	        AND			mdlst = p_modality_code
	        --AND			TO_CHAR(stdy_dt, 'YYYYMMDD') = p_study_date
	        --AND			TO_CHAR(stdy_dt, 'HH24MISS') = NVL(p_study_time, '000000')
	        RETURNING stdy_key INTO v_u_stdy_key;

	        IF SQL%ROWCOUNT = 0 THEN
	        	BEGIN
		        	SELECT	del_yn
		        	INTO		v_del_yn
		        	FROM		study
		        	WHERE		studyuid = p_study_instance_uid
							AND			p_patient_id IN (dcm_pat_id, pat_id)
							AND			mdlst = p_modality_code;
					  EXCEPTION
					  	WHEN NO_DATA_FOUND THEN
					  		  p_event := c_new_stud;
					  		  v_del_yn := 'N';
						END;

	        	IF v_del_yn = 'Y' THEN
	        		p_event := c_dup_study_del_y;
	        	ELSIF p_event <> c_new_stud THEN
	        		p_event := c_dup_study_del_n;
	        	END IF;

	        ELSE
		       /*for archive*/
						UPDATE	studyVol
						SET			--stdy_dt = v_stdy_date_time
									 rgs_dt = v_sysdate
						WHERE		stdy_key = v_u_stdy_key;

						p_event := c_upd_study;
					END IF;
				END IF;
		END;

		COMMIT;

	EXCEPTION
		WHEN e_no_login THEN
			p_event := c_no_login;

		WHEN OTHERS THEN
			p_event := SQLCODE;
			ROLLBACK;
	END SetStudy;
```

```bash
test -d /archive/${CLUSTERNAME} || mkdir /archive/${CLUSTERNAME} || exit;
chown postgres.postgres /archive/${CLUSTERNAME} || exit;
chmod 700 /archive/${CLUSTERNAME} || exit;
```
